<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>えいご じしょ</title>
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            background: #f0f8ff;
            min-height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
        }

        .camera-container {
            position: relative;
            flex: 1;
            background: #000;
            overflow: hidden;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            display: none;
        }

        /* Focus overlay - corner brackets */
        .focus-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 50%;
            pointer-events: none;
            z-index: 10;
        }

        .corner {
            position: absolute;
            width: 40px;
            height: 40px;
            border-color: #ffeb3b;
            border-style: solid;
            border-width: 0;
        }

        .corner-tl {
            top: 0;
            left: 0;
            border-top-width: 6px;
            border-left-width: 6px;
            border-radius: 8px 0 0 0;
        }

        .corner-tr {
            top: 0;
            right: 0;
            border-top-width: 6px;
            border-right-width: 6px;
            border-radius: 0 8px 0 0;
        }

        .corner-bl {
            bottom: 0;
            left: 0;
            border-bottom-width: 6px;
            border-left-width: 6px;
            border-radius: 0 0 0 8px;
        }

        .corner-br {
            bottom: 0;
            right: 0;
            border-bottom-width: 6px;
            border-right-width: 6px;
            border-radius: 0 0 8px 0;
        }

        /* Animated corners */
        .focus-overlay.active .corner {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                border-color: #ffeb3b;
                transform: scale(1);
            }
            50% {
                border-color: #4caf50;
                transform: scale(1.05);
            }
        }

        /* Center guide text */
        .center-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            text-align: center;
            pointer-events: none;
        }

        .focus-overlay.active .center-guide {
            display: none;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .button-row {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            flex: 1;
            max-width: 200px;
            padding: 20px 15px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-capture {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
        }

        .btn-speak {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-translate {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(67, 233, 123, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Result display */
        .result-area {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 5px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .english-text {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .japanese-text {
            font-size: 22px;
            color: #666;
        }

        .placeholder-text {
            color: #aaa;
            font-size: 16px;
        }

        /* Loading indicator */
        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Permission error */
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 80%;
        }

        .error-message h2 {
            color: #f44336;
            margin-bottom: 15px;
        }

        .error-message p {
            color: #666;
            line-height: 1.6;
        }

        /* Progress indicator */
        .progress-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-text {
            color: white;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 200px;
            height: 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            border-radius: 5px;
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>

            <!-- Focus overlay with corner brackets -->
            <div class="focus-overlay" id="focusOverlay">
                <div class="corner corner-tl"></div>
                <div class="corner corner-tr"></div>
                <div class="corner corner-bl"></div>
                <div class="corner corner-br"></div>
                <div class="center-guide">ここに えを あわせてね</div>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-text" id="progressText">よみとりちゅう...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="error-message" id="errorMessage" style="display: none;">
                <h2>カメラが つかえません</h2>
                <p>カメラの きょかを おねがいします</p>
            </div>
        </div>

        <div class="controls">
            <div class="result-area" id="resultArea">
                <span class="placeholder-text">カメラで じしょを うつしてね</span>
            </div>

            <div class="button-row">
                <button class="btn btn-capture" id="captureBtn">
                    <span>よみとる</span>
                </button>
            </div>

            <div class="button-row">
                <button class="btn btn-speak" id="speakBtn" disabled>
                    <span>えいごで よむ</span>
                </button>
                <button class="btn btn-translate" id="translateBtn" disabled>
                    <span>にほんご</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentText = '';
        let japaneseText = '';
        let stream = null;
        let tesseractWorker = null;

        // Children's dictionary - common words with child-friendly explanations
        const childrensDictionary = {
            // Animals
            'ant': 'あり（ちいさい むし）',
            'bear': 'くま（おおきい どうぶつ）',
            'bee': 'はち（はなの みつを あつめる むし）',
            'bird': 'とり（そらを とぶ）',
            'butterfly': 'ちょうちょ（きれいな はねの むし）',
            'cat': 'ねこ',
            'cow': 'うし（ミルクを くれる）',
            'dog': 'いぬ',
            'duck': 'あひる（がーがー なく）',
            'elephant': 'ぞう（おおきくて ながい はな）',
            'fish': 'さかな（みずの なかに いる）',
            'frog': 'かえる（ぴょんぴょん とぶ）',
            'horse': 'うま',
            'lion': 'らいおん（どうぶつの おうさま）',
            'monkey': 'さる',
            'mouse': 'ねずみ（ちいさい どうぶつ）',
            'pig': 'ぶた（ぶーぶー なく）',
            'rabbit': 'うさぎ（ながい みみ）',
            'sheep': 'ひつじ（もこもこ）',
            'snake': 'へび（ながい どうぶつ）',
            'spider': 'くも（あしが 8ほん）',
            'tiger': 'とら（しまもよう）',
            'turtle': 'かめ（こうらが ある）',
            'whale': 'くじら（うみの おおきな どうぶつ）',
            'zebra': 'しまうま',

            // Food
            'apple': 'りんご（あかい くだもの）',
            'banana': 'バナナ（きいろい くだもの）',
            'bread': 'パン',
            'cake': 'ケーキ（あまい おかし）',
            'candy': 'あめ（あまい おかし）',
            'carrot': 'にんじん（オレンジいろの やさい）',
            'cheese': 'チーズ',
            'chocolate': 'チョコレート',
            'cookie': 'クッキー',
            'egg': 'たまご',
            'grape': 'ぶどう',
            'ice cream': 'アイスクリーム',
            'juice': 'ジュース',
            'milk': 'ぎゅうにゅう',
            'orange': 'オレンジ',
            'pizza': 'ピザ',
            'rice': 'ごはん',
            'strawberry': 'いちご（あかい くだもの）',
            'tomato': 'トマト（あかい やさい）',
            'water': 'みず',
            'beetroot': 'ビーツ（まるくて あかい やさい）',

            // Body parts
            'arm': 'うで',
            'ear': 'みみ（おとを きく）',
            'eye': 'め（ものを みる）',
            'face': 'かお',
            'finger': 'ゆび',
            'foot': 'あし',
            'hand': 'て',
            'head': 'あたま',
            'leg': 'あし',
            'mouth': 'くち（たべたり はなしたり）',
            'nose': 'はな（においを かぐ）',
            'tooth': 'は',

            // Colors
            'black': 'くろ',
            'blue': 'あお',
            'brown': 'ちゃいろ',
            'green': 'みどり',
            'orange': 'オレンジいろ',
            'pink': 'ピンク',
            'purple': 'むらさき',
            'red': 'あか',
            'white': 'しろ',
            'yellow': 'きいろ',

            // Family
            'baby': 'あかちゃん',
            'brother': 'おとうと・おにいちゃん',
            'dad': 'おとうさん',
            'daddy': 'パパ',
            'family': 'かぞく',
            'father': 'おとうさん',
            'girl': 'おんなのこ',
            'boy': 'おとこのこ',
            'grandma': 'おばあちゃん',
            'grandpa': 'おじいちゃん',
            'mom': 'おかあさん',
            'mommy': 'ママ',
            'mother': 'おかあさん',
            'sister': 'いもうと・おねえちゃん',

            // Common objects
            'ball': 'ボール',
            'bed': 'ベッド（ねる ところ）',
            'book': 'ほん',
            'box': 'はこ',
            'car': 'くるま',
            'chair': 'いす（すわる もの）',
            'clock': 'とけい（じかんが わかる）',
            'cup': 'コップ',
            'door': 'ドア',
            'flower': 'はな',
            'hat': 'ぼうし',
            'house': 'いえ・おうち',
            'key': 'かぎ',
            'pen': 'ペン（かく もの）',
            'pencil': 'えんぴつ',
            'phone': 'でんわ',
            'picture': 'え・しゃしん',
            'shoe': 'くつ',
            'table': 'テーブル',
            'toy': 'おもちゃ',
            'tree': 'き',
            'umbrella': 'かさ（あめの ひに つかう）',
            'window': 'まど',

            // Actions/Verbs
            'add': 'たす（かずを あわせる）',
            'come': 'くる',
            'dance': 'おどる',
            'drink': 'のむ',
            'eat': 'たべる',
            'go': 'いく',
            'help': 'たすける',
            'jump': 'とぶ（ぴょんぴょん）',
            'listen': 'きく',
            'look': 'みる',
            'play': 'あそぶ',
            'read': 'よむ',
            'run': 'はしる',
            'sing': 'うたう',
            'sit': 'すわる',
            'sleep': 'ねる',
            'stand': 'たつ',
            'stop': 'とまる',
            'swim': 'およぐ',
            'talk': 'はなす',
            'walk': 'あるく',
            'write': 'かく',

            // Adjectives/Feelings
            'afraid': 'こわい（びくびく する）',
            'angry': 'おこっている',
            'bad': 'わるい',
            'beautiful': 'きれい・うつくしい',
            'big': 'おおきい',
            'cold': 'つめたい・さむい',
            'good': 'いい・よい',
            'happy': 'うれしい・しあわせ',
            'hot': 'あつい',
            'hungry': 'おなかが すいた',
            'little': 'ちいさい',
            'long': 'ながい',
            'new': 'あたらしい',
            'old': 'ふるい',
            'sad': 'かなしい',
            'short': 'みじかい',
            'sick': 'びょうき',
            'small': 'ちいさい',
            'tall': 'たかい',
            'tired': 'つかれた',

            // Places
            'home': 'いえ・おうち',
            'park': 'こうえん（あそぶ ところ）',
            'school': 'がっこう',
            'shop': 'おみせ',
            'zoo': 'どうぶつえん',

            // People/Occupations
            'actor': 'はいゆう（げきを する ひと）',
            'doctor': 'おいしゃさん',
            'friend': 'ともだち',
            'teacher': 'せんせい',

            // Other common words
            'address': 'じゅうしょ（すんでいる ばしょ）',
            'afternoon': 'ごご（おひるの あと）',
            'day': 'ひ・いちにち',
            'hello': 'こんにちは',
            'morning': 'あさ',
            'name': 'なまえ',
            'night': 'よる',
            'no': 'いいえ',
            'please': 'おねがいします',
            'sun': 'たいよう・おひさま',
            'moon': 'つき',
            'star': 'ほし',
            'rain': 'あめ',
            'snow': 'ゆき',
            'thank you': 'ありがとう',
            'yes': 'はい',

            // Numbers
            'one': 'いち（1）',
            'two': 'に（2）',
            'three': 'さん（3）',
            'four': 'よん（4）',
            'five': 'ご（5）',
            'six': 'ろく（6）',
            'seven': 'なな（7）',
            'eight': 'はち（8）',
            'nine': 'きゅう（9）',
            'ten': 'じゅう（10）'
        };

        // Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const focusOverlay = document.getElementById('focusOverlay');
        const progressContainer = document.getElementById('progressContainer');
        const progressText = document.getElementById('progressText');
        const progressFill = document.getElementById('progressFill');
        const errorMessage = document.getElementById('errorMessage');
        const resultArea = document.getElementById('resultArea');
        const captureBtn = document.getElementById('captureBtn');
        const speakBtn = document.getElementById('speakBtn');
        const translateBtn = document.getElementById('translateBtn');

        // Initialize Tesseract worker
        async function initTesseract() {
            progressContainer.classList.add('active');
            progressText.textContent = 'じゅんびちゅう...';
            progressFill.style.width = '10%';

            try {
                tesseractWorker = await Tesseract.createWorker('eng', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const percent = Math.round(m.progress * 100);
                            progressFill.style.width = percent + '%';
                        }
                    }
                });
                progressFill.style.width = '100%';
                progressText.textContent = 'じゅんびかんりょう！';
                await new Promise(r => setTimeout(r, 500));
            } catch (err) {
                console.error('Tesseract init error:', err);
                progressText.textContent = 'エラーが おきました';
            } finally {
                progressContainer.classList.remove('active');
                progressFill.style.width = '0%';
            }
        }

        // Initialize camera
        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                video.srcObject = stream;
                await video.play();

                // Set canvas size to match video
                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                });

                focusOverlay.classList.add('active');
            } catch (err) {
                console.error('Camera error:', err);
                errorMessage.style.display = 'block';
                focusOverlay.style.display = 'none';
            }
        }

        // Capture image from camera (center region only)
        function captureImage() {
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;

            // Calculate center region (70% width, 50% height - matching overlay)
            const regionWidth = videoWidth * 0.7;
            const regionHeight = videoHeight * 0.5;
            const startX = (videoWidth - regionWidth) / 2;
            const startY = (videoHeight - regionHeight) / 2;

            // Set canvas to region size
            canvas.width = regionWidth;
            canvas.height = regionHeight;

            // Draw only the center region
            ctx.drawImage(
                video,
                startX, startY, regionWidth, regionHeight,
                0, 0, regionWidth, regionHeight
            );

            return canvas;
        }

        // Perform OCR with Tesseract.js
        async function performOCR(canvasElement) {
            if (!tesseractWorker) {
                throw new Error('Tesseract not initialized');
            }

            progressContainer.classList.add('active');
            progressText.textContent = 'よみとりちゅう...';
            progressFill.style.width = '0%';

            try {
                const result = await tesseractWorker.recognize(canvasElement);
                const text = result.data.text.trim();
                console.log('OCR Result:', text);
                return text;
            } finally {
                progressContainer.classList.remove('active');
                progressFill.style.width = '0%';
            }
        }

        // Extract the main word from OCR text
        function extractMainWord(ocrText) {
            // Clean up and extract words
            const cleaned = ocrText.toLowerCase()
                .replace(/[^a-z\s]/g, ' ')
                .trim();

            const words = cleaned.split(/\s+/).filter(w => w.length > 1);

            if (words.length === 0) return null;

            // Priority: find dictionary word first
            for (const word of words) {
                if (childrensDictionary[word]) {
                    return word;
                }
            }

            // Check for compound words in dictionary
            for (const dictWord of Object.keys(childrensDictionary)) {
                if (cleaned.includes(dictWord)) {
                    return dictWord;
                }
            }

            // Return first reasonable word (2+ letters)
            return words.find(w => w.length >= 2) || words[0];
        }

        // Get Japanese translation
        async function getJapaneseTranslation(englishWord) {
            const lowerWord = englishWord.toLowerCase();

            // Check dictionary first
            if (childrensDictionary[lowerWord]) {
                return childrensDictionary[lowerWord];
            }

            // Try online translation API (MyMemory - free)
            try {
                const response = await fetch(
                    `https://api.mymemory.translated.net/get?q=${encodeURIComponent(englishWord)}&langpair=en|ja`
                );
                const data = await response.json();
                if (data.responseStatus === 200 && data.responseData.translatedText) {
                    return data.responseData.translatedText;
                }
            } catch (err) {
                console.error('Translation API error:', err);
            }

            return '（ほんやく できませんでした）';
        }

        // Text to speech - English
        function speakEnglish(text) {
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.6; // Slower for children
            utterance.pitch = 1.1;
            speechSynthesis.speak(utterance);
        }

        // Text to speech - Japanese
        function speakJapanese(text) {
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.8;
            utterance.pitch = 1.1;
            speechSynthesis.speak(utterance);
        }

        // Update result display
        function updateResult(english, japanese) {
            currentText = english;
            japaneseText = japanese;

            resultArea.innerHTML = `
                <div class="english-text">${english}</div>
                <div class="japanese-text">${japanese}</div>
            `;

            speakBtn.disabled = false;
            translateBtn.disabled = false;
        }

        // Reset result display
        function resetResult() {
            resultArea.innerHTML = '<span class="placeholder-text">カメラで じしょを うつしてね</span>';
            speakBtn.disabled = true;
            translateBtn.disabled = true;
            currentText = '';
            japaneseText = '';
        }

        // Show error in result area
        function showError(message) {
            resultArea.innerHTML = `<span class="placeholder-text">${message}</span>`;
            speakBtn.disabled = true;
            translateBtn.disabled = true;
        }

        // Event listeners
        captureBtn.addEventListener('click', async () => {
            captureBtn.disabled = true;

            try {
                const canvasElement = captureImage();
                const ocrText = await performOCR(canvasElement);

                if (!ocrText || ocrText.length === 0) {
                    showError('もじが みつかりませんでした');
                    return;
                }

                const mainWord = extractMainWord(ocrText);
                if (!mainWord) {
                    showError('ことばが みつかりませんでした');
                    return;
                }

                progressText.textContent = 'ほんやくちゅう...';
                progressContainer.classList.add('active');

                const japanese = await getJapaneseTranslation(mainWord);

                progressContainer.classList.remove('active');

                updateResult(mainWord, japanese);

                // Auto-speak English
                speakEnglish(mainWord);
            } catch (err) {
                console.error('OCR error:', err);
                showError('エラーが おきました');
                progressContainer.classList.remove('active');
            } finally {
                captureBtn.disabled = false;
            }
        });

        speakBtn.addEventListener('click', () => {
            if (currentText) {
                speakEnglish(currentText);
            }
        });

        translateBtn.addEventListener('click', () => {
            if (japaneseText) {
                speakJapanese(japaneseText);
            }
        });

        // Initialize
        async function init() {
            await initCamera();
            await initTesseract();
        }

        init();
    </script>
</body>
</html>
